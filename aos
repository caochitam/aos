#!/bin/bash
# AOS Startup Script
#
# Features:
# - Interactive API key setup (auto-detects missing key)
# - Security sanitization (prompt injection protection)
# - Persistent configuration
#
# Usage:
#   ./aos           - Start AOS (fast mode if uberjar exists)
#   ./aos --dev     - Force dev mode (use lein run)
#   ./aos --rebuild - Rebuild uberjar and start
#   ./aos --help    - Show this help

set -e

AOS_DIR="/root/aos"
UBERJAR="$AOS_DIR/target/uberjar/agent-os-0.1.0-SNAPSHOT-standalone.jar"

cd "$AOS_DIR"

# Parse arguments
case "${1:-}" in
    --help|-h)
        echo "AOS - Agent Operating System"
        echo ""
        echo "Usage:"
        echo "  ./aos           Start AOS (interactive setup if needed)"
        echo "  ./aos --dev     Force dev mode (lein run)"
        echo "  ./aos --rebuild Rebuild uberjar and start"
        echo "  ./aos --help    Show this help"
        echo ""
        echo "Features:"
        echo "  ‚úì Interactive API key setup"
        echo "  ‚úì Persistent configuration"
        echo "  ‚úì Security sanitization"
        echo "  ‚úì Prompt injection protection"
        echo ""
        echo "First-time setup:"
        echo "  1. Run: ./aos"
        echo "  2. Follow interactive prompts"
        echo "  3. API key configured permanently!"
        echo ""
        exit 0
        ;;

    --dev)
        echo "üîß Starting AOS in dev mode (lein run)..."
        exec lein run "${@:2}"
        ;;

    --rebuild)
        echo "üî® Rebuilding uberjar..."
        lein uberjar
        echo "‚úì Rebuild complete"
        echo ""
        echo "üöÄ Starting AOS..."
        exec java -jar "$UBERJAR" "${@:2}"
        ;;
esac

# Normal startup: prefer uberjar for speed, fallback to lein
if [ -f "$UBERJAR" ]; then
    # Quick check: is any core source file newer than JAR?
    CORE_FILES=(
        "src/agent_os/llm/delegator.clj"
        "src/agent_os/cli/gateway.clj"
        "src/agent_os/setup/interactive.clj"
    )

    NEEDS_REBUILD=false
    for src_file in "${CORE_FILES[@]}"; do
        if [ "$src_file" -nt "$UBERJAR" ]; then
            NEEDS_REBUILD=true
            break
        fi
    done

    if [ "$NEEDS_REBUILD" = "true" ]; then
        echo "‚ö†Ô∏è  Code ƒë√£ thay ƒë·ªïi - JAR c·∫ßn rebuild!"
        echo ""
        echo "   L·ª±a ch·ªçn:"
        echo "   [1] Rebuild ngay (recommended) - 30s"
        echo "   [2] Dev mode l·∫ßn n√†y (slow startup)"
        echo "   [3] D√πng JAR c≈© (c√≥ th·ªÉ b·ªã l·ªói)"
        echo ""
        read -p "Ch·ªçn [1-3, default=1]: " -n 1 -r choice
        echo ""
        echo ""

        case "${choice:-1}" in
            1)
                echo "üî® Rebuilding uberjar..."
                lein uberjar
                echo "‚úì Rebuild ho√†n t·∫•t!"
                echo ""
                ;;
            2)
                echo "üîß Dev mode cho l·∫ßn n√†y..."
                exec lein run "$@"
                ;;
            3)
                echo "‚ö†Ô∏è  C·∫¢NH B√ÅO: D√πng JAR c≈© - code b·∫•t ƒë·ªìng b·ªô!"
                echo ""
                ;;
        esac
    fi

    # Fast startup with compiled uberjar
    exec java -jar "$UBERJAR" "$@"
else
    # Dev mode (uberjar not built yet)
    echo "‚ÑπÔ∏è  First run - using dev mode (slower)"
    echo "   Tip: Run './aos --rebuild' to build fast uberjar"
    echo ""
    exec lein run "$@"
fi
